version: "3.8"

services:
  # Сервис для предзагрузки модели ИИ
  # model-preloader:
  #   build:
  #     context: ./ai
  #     dockerfile: Dockerfile
  #   environment:
  #     - QWEN_MODEL_NAME=${QWEN_MODEL_NAME:-Qwen/Qwen3-4B-Instruct}
  #     - AI_VERIFICATION_VERBOSE=${AI_VERIFICATION_VERBOSE:-false}
  #     - HF_HOME=/models
  #     - DISABLE_TRITON=0
  #     - NVIDIA_VISIBLE_DEVICES=all
  #   volumes:
  #     - model-cache:/models
  #   restart: on-failure
  #   command: python3 preload_model.py
  #   deploy:
  #     resources:
  #       reservations:
  #         devices:
  #           - driver: nvidia
  #             count: all
  #             capabilities: [gpu]
  #   healthcheck:
  #     test: ["CMD", "python3", "-c", "import os; exit(0 if os.path.exists('/models/hub') else 1)"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 3

  # backend:
  #   build:
  #     context: .
  #     dockerfile: ./backend/Dockerfile
  #   environment:
  #     - SPRING_DATA_MONGODB_URI=mongodb://${MONGO_USERNAME}:${MONGO_PASSWORD}@${MONGO_HOST}:${MONGO_PORT}/${MONGO_DB_NAME}?authSource=admin
  #     - QWEN_MODEL_NAME=${QWEN_MODEL_NAME:-Qwen/Qwen3-4B-Instruct}
  #     - AI_VERIFICATION_VERBOSE=${AI_VERIFICATION_VERBOSE:-false}
  #     - HF_HOME=/models
  #     - DISABLE_TRITON=0
  #     - NVIDIA_VISIBLE_DEVICES=all
  #   volumes:
  #     - model-cache:/modelsЦу м
  #   depends_on:
  #     mongo:
  #       condition: service_started
  #     model-preloader:
  #       condition: service_completed_successfully
  #   ports:
  #     - "${BACKEND_HOST_PORT}:${BACKEND_CONTAINER_PORT}"
  #   deploy:
  #     resources:
  #       reservations:
  #         devices:
  #           - driver: nvidia
  #             count: all
  #             capabilities: [gpu]

  nginx:
    image: nginx:alpine
    container_name: vtb-nginx
    environment:
      - BACKEND_HOST=${BACKEND_HOST}
      - BACKEND_PORT=${BACKEND_PORT}
      - API_PREFIX=${API_PREFIX}
      - WS_PATH=${WS_PATH}
      - CLIENT_MAX_BODY_SIZE=${CLIENT_MAX_BODY_SIZE}
    ports:
      - "${NGINX_HOST_PORT}:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf.template:ro
      - frontend_dist:/usr/share/nginx/html:ro
    # depends_on:
    #   - backend
    command: /bin/sh -c "envsubst '$${BACKEND_HOST} $${BACKEND_PORT} $${API_PREFIX} $${WS_PATH} $${CLIENT_MAX_BODY_SIZE}' < /etc/nginx/nginx.conf.template > /etc/nginx/nginx.conf && nginx -g 'daemon off;'"

  frontend-build:
    build:
      context: ./frontend-vtb
      target: build
    volumes:
      - frontend_dist:/out
    command: sh -c "cp -r /app/dist/* /out/ || true && ls -la /out && echo 'Build copied to volume'"

  mongo:
    image: mongo:6
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_USERNAME}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_PASSWORD}
      - MONGO_INITDB_DATABASE=${MONGO_DB_NAME}
    ports:
      - "27017:27017"
    volumes:
      - mongo-data:/data/db

volumes:
  frontend_dist: {}
  mongo-data:
  # model-cache:
  #   drive: local